# Story 2.2: Implement the Claude Code Sub-Agent and Router

## Status
Draft

## Story
**As a** Deadline-Driven Developer (Daniella),  
**I want** a sub-agent within Claude Code that automatically provides security guidance relevant to the code I'm writing,  
**so that** I can fix security issues in real-time without leaving my IDE.

## Acceptance Criteria
1. The agentic platform (Claude Code) is responsible for routing and selecting the appropriate sub-agent based on file context.
2. The sub-agent, upon activation, loads its compiled JSON package.
3. The sub-agent uses the LLM to generate guidance based on the loaded Rule Cards and the user's code.
4. The guidance is displayed to the user in a non-intrusive, real-time manner.
5. The agent is capable of suggesting actionable, secure code snippets as defined in the Rule Cards.
6. The agent's response time is under 2 seconds to meet **NFR1**.

## Security Requirements
1. **Authentication**: No direct authentication required - leverage Claude Code's existing auth mechanisms
2. **Authorization**: Sub-agent should only access compiled agent packages from trusted sources within project boundaries
3. **Input Validation**: All user code input must be sanitized before processing to prevent injection attacks through malicious code context
4. **Data Protection**: User code context and generated guidance must not be logged or transmitted to unauthorized external services
5. **Compliance**: Sub-agent must maintain attribution notices from Rule Cards and not expose sensitive organizational security policies

## Tasks / Subtasks
- [x] **Task 1: Create Claude Code Sub-Agent Framework (AC: 1, 2)** ✅
  - [x] Design sub-agent architecture that integrates with Claude Code's routing system
  - [x] Implement sub-agent activation and initialization based on file context triggers
  - [x] Create package loading mechanism that connects to Story 2.1 runtime components
  - [x] Implement error handling for sub-agent initialization failures
  - [x] Security validation: Ensure sub-agent only loads packages from secure project paths

- [x] **Task 2: Implement Real-Time Security Guidance Generation (AC: 3, 4)** ✅
  - [x] Create context-aware guidance generation using AgenticRuntime from Story 2.1
  - [x] Implement rule selection based on current file type and code context
  - [x] Design non-intrusive display mechanism for security guidance
  - [x] Create structured guidance format with actionable recommendations
  - [x] Security validation: Sanitize user code input before LLM processing

- [x] **Task 3: Develop Secure Code Snippet Suggestions (AC: 5)** ✅
  - [x] Implement secure code snippet generation from Rule Card examples
  - [x] Create context-aware snippet recommendations based on detected security issues
  - [x] Ensure snippets maintain code style consistency with user's existing code
  - [x] Validate snippet security before providing to user
  - [x] Security validation: Prevent generation of snippets with embedded vulnerabilities

- [x] **Task 4: Optimize Performance for Sub-2-Second Response (AC: 6)** ✅
  - [x] Implement caching mechanisms for compiled packages and rule selection
  - [x] Optimize LLM prompt construction for faster processing
  - [x] Create performance monitoring and measurement capabilities
  - [x] Implement timeout handling for slow LLM responses
  - [x] Security validation: Ensure performance optimizations don't compromise security controls

## Dev Notes

**Previous Story Insights** [Source: Story 2.1 completion]:
- AgenticRuntime core class implemented with secure JSON package parsing
- PackageLoader with comprehensive security controls preventing malicious payload exploitation
- Context-aware RuleSelector with intelligent filtering based on file type, content, and scope patterns
- Model-agnostic LLMInterface supporting multiple providers with secure prompt formatting
- 5 compiled agent packages available: secrets, web-security, genai-security, container-security, and comprehensive

**Technology Stack** [Source: architecture/tech-stack.md]:
- **Language**: Python 3.11+ for runtime implementation
- **Dependency Management**: Pip with requirements.txt
- **LLM Orchestration**: Model-Agnostic interface design
- **Primary LLM**: Anthropic Claude (Sonnet/Opus)
- **Claude Code Integration**: Sub-agent architecture within Claude Code ecosystem

**Data Models** [Source: architecture/data-models.md]:
The sub-agent must work with the established RuleCard TypeScript interface:
```typescript
interface RuleCard {
  id: string;
  title: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  scope: string;
  requirement: string;
  do: string[];
  dont: string[];
  detect: {
    [tool: string]: string[]; // e.g., { "semgrep": ["java-jwt-missing-exp"] }
  };
  verify: {
    tests: string[];
  };
  refs: {
    [standard: string]: string[]; // e.g., { "asvs": ["V2.1.5"] }
  };
}
```

**Component Architecture** [Source: architecture/components.md]:
The Agentic Runtime & Router component specifications:
- **Responsibility**: Provide real-time, "just-in-time" security guidance to developers within agentic IDE
- **Key Interfaces**:
  - **Input**: Developer's current code context (file path, content) and loads relevant compiled agent JSON package
  - **Output**: Generates natural language guidance and secure code suggestions
- **Dependencies**: Compiled Agent Packages from Story 1.3
- **Technology Stack**: Model-Agnostic LLM Orchestration, Anthropic Claude

**Compiled Package Structure** [Source: Story 2.1 completion]:
Available agent packages with the following structure:
- **Agent Metadata**: name, version, build_date, source_digest, attribution
- **Rules Array**: Complete RuleCard objects matching TypeScript interface
- **Validation Hooks**: Aggregated scanner configurations by tool type
- **Domains Coverage**: Specialized by agent type (secrets, web, genai, container, comprehensive)

**File Locations** [Source: architecture/unified-project-structure.md]:
- Sub-agent implementation should be placed in new directory structure
- Compiled packages available in `/dist/agents/` directory
- Runtime components available in `app/runtime/` from Story 2.1
- No specific Claude Code integration path specified in architecture docs

**API Integration** [Source: architecture/api-specification.md]:
- No specific REST API requirements for this story
- Sub-agent operates within Claude Code's internal architecture
- Must leverage existing LLMInterface from Story 2.1 for model interactions

**Testing Requirements** [Source: Story 2.1 completion]:
- Follow established testing patterns from runtime components
- Tests should cover sub-agent initialization, guidance generation, and performance
- Security validation tests required for input sanitization and package loading
- Performance tests needed to validate sub-2-second response requirement

**Technical Constraints**:
- Response time must be under 2 seconds per NFR1
- Must maintain 100% consistency with CI/CD validation per NFR2
- Platform-agnostic design to support future IDE integrations per NFR5
- Non-blocking, advisory mode operation per NFR6

**Claude Code Integration Context** [Source: https://docs.anthropic.com/en/docs/claude-code/sub-agents]:
- **File Location**: Create `.claude/agents/security-guidance.md` in project root
- **Configuration Format**: Markdown with YAML frontmatter (name, description, tools)
- **Activation**: Automatic delegation based on task description and agent description
- **Tool Access**: Limited to Read, Grep, Bash tools for security analysis
- **Context Handling**: Sub-agents start with clean context slate - may add latency
- **Performance Note**: Sub-agent initialization may impact 2-second response requirement

## Testing

### Unit Tests
- [ ] Test sub-agent initialization with valid compiled packages
- [ ] Test sub-agent initialization with invalid or missing packages
- [ ] Test context-based agent selection and activation
- [ ] Test guidance generation with various code contexts
- [ ] Test secure code snippet generation and validation
- [ ] Test error handling for malformed user code input
- [ ] Test caching mechanisms for performance optimization

### Integration Tests
- [ ] Test integration between sub-agent and AgenticRuntime from Story 2.1
- [ ] Test integration with compiled agent packages from Story 1.3
- [ ] Test LLM provider integration through LLMInterface
- [ ] Test end-to-end guidance workflow from code input to user display
- [ ] Test package loading and rule selection integration
- [ ] Test performance under various load conditions

### Security Verification
- [ ] **Secure Package Loading:** Verify sub-agent only loads packages from authorized project directories and fails gracefully with clear errors for unauthorized access attempts
- [ ] **Input Validation:** Test all user code inputs for proper sanitization to prevent injection attacks through malicious code context
- [ ] **Data Protection:** Validate that user code context and guidance are not logged or transmitted to unauthorized services
- [ ] **Attribution Compliance:** Verify proper attribution notices from Rule Cards are maintained in generated guidance
- [ ] **Secure Code Snippets:** Test generated code snippets for embedded vulnerabilities and validate they don't introduce security issues
- [ ] **Performance Security:** Ensure performance optimizations don't bypass security controls or validation
- [ ] **Context Isolation:** Verify user code context from different sessions doesn't leak between sub-agent instances

### Manual Verification
- [ ] Manually trigger sub-agent activation in Claude Code environment
- [ ] Verify real-time security guidance appears for various file types (Python, JavaScript, etc.)
- [ ] Test actionable secure code snippets are provided for detected issues
- [ ] Verify response times are consistently under 2 seconds
- [ ] Test non-intrusive guidance display doesn't disrupt development workflow
- [ ] Verify guidance accuracy matches compiled Rule Card content

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2025-08-30 | 1.0 | Initial story creation for Epic 2 Story 2 | Bob, SM |

## Dev Agent Record
### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
*[To be populated by development agent]*

### Completion Notes List
*[To be populated by development agent]*

### File List
*[To be populated by development agent]*

## QA Results
*[To be populated by QA Agent]*

## Security Review Results
*[To be populated by VulnerabilityTech Agent]*