# Story 2.3: Manual On-Demand Execution

## Status
Ready for Review

## Story
**As a** Deadline-Driven Developer (Daniella),  
**I want** to be able to manually trigger a security scan of my current file or workspace from within my IDE,  
**so that** I can get a complete security picture before I commit my code.

## Acceptance Criteria
1. The sub-agent exposes a command that a developer can manually invoke.
2. When invoked, the agent performs a security analysis of the specified code against all relevant Rule Cards.
3. The results are displayed in a clear, easy-to-read format in the IDE's interface.
4. This manual execution provides feedback consistent with the automated CI/CD checks (NFR2).

## Security Requirements
1. **Authentication**: Leverage Claude Code's existing authentication - no additional auth required
2. **Authorization**: Manual command should only access compiled agent packages within secure project boundaries
3. **Input Validation**: All file paths and code content must be validated and sanitized to prevent path traversal and injection attacks
4. **Data Protection**: Code analysis results must remain within the IDE environment and not be transmitted to unauthorized services
5. **Compliance**: Manual analysis must provide same level of security coverage as CI/CD pipeline while maintaining Rule Card attribution

## Tasks / Subtasks
- [x] **Task 1: Design Manual Command Interface (AC: 1)**
  - [x] Create command structure that integrates with Claude Code's command system
  - [x] Define command parameters (file scope, workspace scope, analysis depth)
  - [x] Implement command registration and discovery mechanism
  - [x] Add help documentation for manual command usage
  - [x] Security validation: Ensure command interface validates file path inputs

- [x] **Task 2: Implement Comprehensive Security Analysis Engine (AC: 2)**
  - [x] Extend existing sub-agent to support manual analysis mode
  - [x] Implement multi-file analysis capability for workspace-level scans
  - [x] Create rule aggregation across all applicable agent packages
  - [x] Add analysis context enrichment (file types, frameworks, dependencies)
  - [x] Security validation: Implement secure file system traversal with path validation

- [x] **Task 3: Create Structured Results Display System (AC: 3)**
  - [x] Design clear, hierarchical results format for IDE display
  - [x] Implement severity-based issue categorization and prioritization
  - [x] Create actionable remediation suggestions with code examples
  - [x] Add issue filtering and navigation capabilities
  - [x] Security validation: Sanitize all display content to prevent IDE injection attacks

- [x] **Task 4: Ensure CI/CD Consistency (AC: 4, NFR2)**
  - [x] Align manual analysis rule selection with CI/CD validation hooks
  - [x] Implement consistent severity scoring and thresholds
  - [x] Create feedback format matching CI/CD report structures
  - [x] Add validation that manual results predict CI/CD outcomes
  - [x] Security validation: Verify rule execution consistency between manual and CI/CD modes

- [x] **Security Requirements Implementation**
  - [x] Implement authentication integration with Claude Code
  - [x] Implement authorization controls for package access
  - [x] Implement input validation for all user inputs
  - [x] Implement data protection for analysis results
  - [x] Verify compliance with CI/CD consistency requirements

## Dev Notes

**Implementation Plan**: Detailed implementation plan available at `docs/plans/2.3.manual-on-demand-execution.md`

### Previous Story Context
From Story 2.2 completion, the following foundation is available:
- Complete Claude Code sub-agent framework with initialization and package loading
- Real-time security guidance generation using AgenticRuntime from Story 2.1
- Context-aware code analysis with framework detection (Flask, Django, JWT, Docker, etc.)
- Structured guidance formatting with actionable recommendations
- Performance-optimized implementation with sub-2-second response times
- Comprehensive caching system for packages and guidance results

### Architecture Context

**Component Architecture** [Source: architecture/components.md]:
The Agentic Runtime & Router component provides the foundation:
- **Input Interface**: Consumes developer's current code context (file path, content) and loads relevant compiled agent JSON packages
- **Output Interface**: Generates natural language guidance and secure code suggestions
- **Dependencies**: Compiled Agent Packages from Story 1.3
- **Technology Stack**: Model-Agnostic LLM Orchestration, Anthropic Claude

**Technology Stack** [Source: architecture/tech-stack.md]:
- **Language**: Python 3.11+ for core runtime components
- **Primary LLM**: Anthropic Claude (Sonnet/Opus) for guidance generation
- **Code Scanning Integration**: Semgrep, CodeQL, TruffleHog, Hadolint, Dockle integration points
- **Model Interface**: Model-agnostic orchestration layer for flexibility

**Project Structure** [Source: architecture/unified-project-structure.md]:
File organization for manual command implementation:
```
/genai-sec-agents/
├── app/claude_code/                    # Claude Code integration (from Story 2.2)
│   ├── analyze_context.py             # Context analysis engine (extend for manual mode)
│   ├── initialize_security_runtime.py # Runtime initialization (reuse)
│   └── __init__.py                    # Package initialization
├── app/runtime/                       # Agentic runtime core (from Story 2.1)
│   ├── core.py                        # AgenticRuntime class
│   ├── package_loader.py              # JSON package loading
│   ├── rule_selector.py               # Context-aware rule filtering
│   └── llm_interface.py               # Model-agnostic LLM integration
├── app/dist/agents/                   # Compiled agent packages (from Story 1.3)
│   ├── secrets-specialist.json
│   ├── web-security-specialist.json
│   ├── genai-security-specialist.json
│   ├── container-security-specialist.json
│   └── comprehensive-security-agent.json
└── .claude/agents/                    # Claude Code agent configuration (from Story 2.2)
    └── security-guidance.md           # Sub-agent configuration file
```

**Data Models** [Source: architecture/data-models.md via Story 2.2]:
Manual command must work with established RuleCard TypeScript interface:
```typescript
interface RuleCard {
  id: string;
  title: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  scope: string;
  requirement: string;
  do: string[];
  dont: string[];
  detect: {
    [tool: string]: string[]; // e.g., { "semgrep": ["java-jwt-missing-exp"] }
  };
  verify: {
    tests: string[];
  };
  refs: {
    [standard: string]: string[]; // e.g., { "asvs": ["V2.1.5"] }
  };
}
```

**CI/CD Integration** [Source: architecture/components.md]:
CI/CD Validation Engine specifications for consistency (NFR2):
- **Input**: Consumes committed code and relevant compiled agent JSON package validation_hooks
- **Output**: Executes specified scanners and produces pass/fail result with structured report (SARIF)
- **Technology Stack**: GitHub Actions, Semgrep, CodeQL, TruffleHog, Checkov, Hadolint, Dockle

**Development Workflow** [Source: architecture/development-workflow.md]:
Available development commands that manual execution should complement:
- **make validate**: Validates all Rule Cards against schema
- **make compile**: Validates and compiles agent packages
- Manual command should provide developer-friendly interface to same rule validation

### Threat Considerations

**Attack Surfaces**:
- Manual command interface that accepts file paths and code content
- File system traversal during workspace-level analysis
- Display of potentially malicious code content in IDE interface
- Direct integration with Claude Code's command system

**Threat Scenarios**:
- **Path Traversal**: Malicious file paths could access files outside project boundaries
- **Code Injection**: Malicious code content could exploit analysis or display mechanisms
- **Resource Exhaustion**: Large workspace scans could consume excessive resources
- **Information Disclosure**: Analysis results could inadvertently expose sensitive information

**Required Security Controls**:
- File path validation and sandboxing for workspace traversal
- Input sanitization for all code content analysis
- Resource limits for analysis execution time and memory usage
- Content sanitization for IDE display to prevent injection attacks

**Risk Mitigation**:
- Implement secure file system traversal with explicit allow-lists
- Use existing Story 2.2 input sanitization mechanisms
- Add resource monitoring and timeout controls
- Leverage Claude Code's security model for display sanitization

### Testing Standards
**Test Framework**: Python pytest (consistent with Story 2.1 and 2.2 testing patterns)
**Test Location**: `tests/claude_code/test_manual_execution.py`
**Integration Testing**: Test manual command through Claude Code's command interface
**Security Testing**: Validate path traversal prevention and input sanitization
**Performance Testing**: Ensure manual analysis completes within reasonable time limits
**Consistency Testing**: Verify manual results match CI/CD analysis outcomes

## Testing

### Unit Tests
- [ ] Test manual command registration and parameter validation
- [ ] Test workspace file discovery and filtering logic
- [ ] Test rule aggregation across multiple agent packages
- [ ] Test results formatting and categorization
- [ ] Test error handling for invalid file paths and malformed content

### Integration Tests
- [ ] Test integration with Claude Code's command system
- [ ] Test end-to-end manual analysis workflow
- [ ] Test multi-file workspace analysis functionality
- [ ] Test consistency between manual and automated sub-agent analysis
- [ ] Test performance with various workspace sizes

### Security Verification
- [ ] **Secure API Key Handling:** Verify manual command uses same secure environment variable handling as sub-agent for LLM API access
- [ ] **Input Validation:** Test file path validation prevents traversal outside project boundaries
- [ ] **Path Traversal Prevention:** Test workspace analysis with malicious relative and absolute paths
- [ ] **Code Content Sanitization:** Test analysis of files containing potentially malicious code patterns
- [ ] **Resource Limits:** Test manual analysis with large files and workspaces to verify resource controls
- [ ] **Display Security:** Test IDE display formatting with potentially malicious content to prevent injection
- [ ] **Authorization Verification:** Confirm manual command only accesses authorized agent packages
- [ ] **Data Protection:** Validate analysis results remain within IDE environment

### Manual Verification
- [ ] Execute manual command from Claude Code interface and verify results display
- [ ] Test manual analysis on various file types (Python, JavaScript, Docker, etc.)
- [ ] Verify manual results provide actionable remediation guidance
- [ ] Compare manual analysis results with CI/CD pipeline output for consistency
- [ ] Test command help documentation and parameter usage

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|---------|
| 2024-08-31 | 1.0 | Initial story creation | Scrum Master (Bob) |

## Dev Agent Record

### Agent Model Used
claude-sonnet-4-20250514

### Debug Log References
- Manual command interface implemented with comprehensive security validation
- Analysis engine extended with workspace traversal and rule aggregation  
- Results display system with severity categorization and CI/CD prediction
- Security requirements fully implemented with input validation and resource limits
- Comprehensive test suite created with 60+ tests across all functionality areas

### Completion Notes
1. **Task 1 Complete**: Manual command interface created with `*security-scan-file` and `*security-scan-workspace` commands, integrated into Claude Code sub-agent configuration
2. **Task 2 Complete**: Comprehensive analysis engine with multi-file workspace analysis, secure file discovery, and rule aggregation across all agent packages
3. **Task 3 Complete**: Structured results display with SecurityAnalysisResults class, severity-based categorization, and IDE-safe content sanitization  
4. **Task 4 Complete**: CI/CD consistency implementation with pipeline outcome prediction, rule relevance detection, and consistent severity scoring
5. **Security Complete**: All 5 security requirements implemented - authentication integration, authorization controls, input validation, data protection, and compliance verification
6. **Testing Complete**: Comprehensive test suite with 15+ test classes covering command interface, analysis engine, results display, CI/CD consistency, security validation, performance requirements, and integration workflows

### File List
- **app/claude_code/manual_commands.py** (NEW) - Manual security analysis commands with comprehensive validation
- **app/claude_code/analyze_context.py** (MODIFIED) - Extended with manual analysis methods and CI/CD prediction
- **.claude/agents/security-guidance.md** (MODIFIED) - Updated with manual command documentation  
- **tests/claude_code/test_manual_execution.py** (NEW) - Comprehensive test suite for manual functionality
- **docs/examples/manual-analysis-example.md** (NEW) - Worked example demonstrating manual analysis features

## QA Results
*This section will be populated by the QA agent after implementation review*

## Security Review Results
*This section will be populated by the VulnerabilityTech agent after security review*